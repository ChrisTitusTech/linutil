name: Label PR

on:
  pull_request:
    types: [opened]

jobs:
  labelPR:
    runs-on: ubuntu-latest
    permissions:
      issues: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Extract referenced issues
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          ISSUES=$(echo "$PR_BODY" | grep -Eio '(Fixes|Resolves|Closes):? #[0-9]+' | grep -Eo '[0-9]+' | uniq)
          {
            echo "ISSUES<<EOF"
            echo "$ISSUES"
            echo "EOF"
          } >> $GITHUB_ENV

      - name: Get issue labels
        if: env.ISSUES != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          LABELS=()

          # Iterate over ISSUES safe from shell injection (ISSUES only contains numbers)
          for ISSUE in $ISSUES; do
            ISSUE_LABELS=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/$REPO/issues/$ISSUE" \
              | jq -r '.labels[].name')

            while IFS= read -r LABEL; do
              if [[ "$LABEL" == *:* ]]; then
                LABELS+=("$LABEL")
              fi
            done <<< "$ISSUE_LABELS"
          done

          UNIQUE_LABELS=$(printf "%s\n" "${LABELS[@]}" | sort -u | tr '\n' ',' | sed 's/,$//')
          {
            echo "LABELS<<EOF"
            echo "$UNIQUE_LABELS"
            echo "EOF"
          } >> $GITHUB_ENV

      - name: Assign labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          if [[ -n "$LABELS" ]]; then
            gh pr edit "$PR_NUMBER" --add-label "initial review required,$LABELS"
          else
            gh pr edit "$PR_NUMBER" --add-label "initial review required"
          fi
